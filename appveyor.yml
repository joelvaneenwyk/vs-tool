version: 1.0.{build}

environment:
  ANDROID_HOME: "C:\\android-sdk-windows"
  ANDROID_NDK_HOME: "C:\\android-sdk-windows\\ndk-bundle"
  JAVA_HOME: "C:\\Program Files\\Java\\jdk1.8.0"
  ANDROID_TOOLS_URL: "https://dl.google.com/android/repository/sdk-tools-windows-3859397.zip"
  EMSCRIPTEN_VERSION: 1.37.27
  EMSCRIPTEN: c:\projects\vs-tool\emsdk\emscripten\1.37.27
  CLANG_BIN: c:\projects\vs-tool\emsdk\clang\e1.37.27_64bit
  MINGW_BIN: C:\mingw-w64\x86_64-6.3.0-posix-seh-rt_v5-rev1
  matrix:
    # Visual Studio 2010
    - APPVEYOR_BUILD_WORKER_IMAGE: Visual Studio 2013
      VERSION: vs2010
      DEFINES: VS2010DLL
    # Visual Studio 2012
    - APPVEYOR_BUILD_WORKER_IMAGE: Visual Studio 2013
      VERSION: vs2012
      DEFINES: VS2012DLL
    # Visual Studio 2013
    - APPVEYOR_BUILD_WORKER_IMAGE: Visual Studio 2013
      SRC_FOLDER: Workspace
      VERSION: vs2013
      DEFINES: VS2013DLL
    # Visual Studio 2015
    - APPVEYOR_BUILD_WORKER_IMAGE: Visual Studio 2015
      VERSION: vs2015
      DEFINES: VS2015DLL
    # Visual Studio 2017
    - APPVEYOR_BUILD_WORKER_IMAGE: Visual Studio 2017
      VERSION: vs2017
      DEFINES: VS2017DLL

clone_folder: c:\projects\vs-tool

init:
  # Download the Android SDK
  - appveyor DownloadFile %ANDROID_TOOLS_URL% -FileName android-tools.zip
  - 7z x android-tools.zip -o"%ANDROID_HOME%" > nul

  - mkdir C:\Users\appveyor\.android
  - ps: 'New-Item C:\Users\appveyor\.android\repositories.cfg -type file'
  - ps: for($i=0;$i -lt 30;$i++) { $response += "y`n"}; $response | & $Env:ANDROID_HOME\tools\bin\sdkmanager --licenses
  - move '%ANDROID_HOME%\tools' %ANDROID_HOME%\old_tools'
  - '%ANDROID_HOME%\old_tools\bin\sdkmanager.bat tools'
  - '%ANDROID_HOME%\tools\bin\sdkmanager.bat platform-tools'
  - '%ANDROID_HOME%\tools\bin\sdkmanager.bat build-tools;25.0.0'
  - '%ANDROID_HOME%\tools\bin\sdkmanager.bat platforms;android-25'
  - '%ANDROID_HOME%\tools\bin\sdkmanager.bat extras;android;m2repository'
  - '%ANDROID_HOME%\tools\bin\sdkmanager.bat --channel=1 ndk-bundle'
  - '%ANDROID_HOME%\tools\bin\sdkmanager.bat cmake;3.6.4111459'

  # Download the Emscripten SDK
  - ps: Start-FileDownload 'https://s3.amazonaws.com/mozilla-games/emscripten/releases/emsdk-portable-64bit.zip'
  - cmd: 7z x emsdk-portable-64bit.zip -o%APPVEYOR_BUILD_FOLDER%\emsdk

configuration:
  - Release

install:
  - cmd: emsdk\emsdk update
  - cmd: emsdk\emsdk install emscripten-%EMSCRIPTEN_VERSION%
  - cmd: emsdk\emsdk activate emscripten-%EMSCRIPTEN_VERSION%

before_build:
  - nuget restore Workspace\vs-tool.%VERSION%.sln

build_script:
  - msbuild Source\vs-tool.Build.CPPTasks\vs-tool.Build.CPPTasks.%VERSION%.csproj /property:Configuration=Release /p:Platform="Any CPU" /p:DefineConstants="%DEFINES%" /t:Clean,Build
  - msbuild Samples\simple\simple.%VERSION%.vcxproj /property:Configuration=Release /p:Platform="Emscripten" /t:Clean,Build

after_test:
   -